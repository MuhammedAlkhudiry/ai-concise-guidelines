# AGENTS.md

This file provides guidance to AI coding agents working in this repository.

## Project Overview

This repository contains opinionated AI guidelines, skills, and agents for **Claude Code** and **OpenCode**. The content is installed to user machines via `src/init.ts`. This is a **documentation/configuration repository** with a generator script.

## Repository Structure

```
├── content/                 # SOURCE OF TRUTH (all text content)
│   ├── base-rules.md        # Global rules for all modes
│   └── instructions/        # All skill/agent instructions
│       ├── <name>.md
│       └── auditing/        # Audit-related instructions
├── config/                  # Configuration (DRY)
│   ├── models.ts            # Model definitions (OpenCode + Claude Code)
│   ├── agents.ts            # Agent configurations (build only)
│   └── skills.ts            # Skill configurations (all behaviors)
├── src/                     # Scripts and shared utilities
│   ├── fs.ts                # Shared filesystem utilities
│   ├── print.ts             # Colored console output
│   ├── generate.ts          # Generator script (both tools)
│   └── init.ts              # Installer script (both tools)
├── plugins/                 # OpenCode plugins (source)
│   └── loop.ts              # Autonomous loop plugin
├── shell/                   # Shell configuration files
│   ├── zsh-custom.zsh       # Custom zsh config
│   └── zshrc.zsh            # Reference .zshrc (manual setup)
├── output/                  # GENERATED OUTPUT (do not edit directly)
│   ├── opencode/            # OpenCode output
│   │   ├── agents/          # Only build agent
│   │   ├── skills/          # All skills
│   │   ├── plugin/
│   │   └── opencode-config.json
│   └── claude/              # Claude Code output
│       ├── agents/          # Only build agent
│       ├── skills/          # All skills
│       └── settings.json
└── AGENTS.md                # AI agent instructions for this repo
```

## Commands

Use `make` for common tasks:

| Command | Description |
|---------|-------------|
| `make install` | Generate + init — **always use this** |
| `make generate` | Generate only (rarely needed) |
| `make init` | Install only (rarely needed) |

**Always run `make install`** after modifying content or config.

---

## Code Style Guidelines

### Content Files (`content/`)

All instruction content lives here. No frontmatter—frontmatter is added during generation.

- `base-rules.md` — Global rules applied to all modes
- `instructions/*.md` — Individual skill/agent instructions

### Config Files (`config/`)

TypeScript configuration files:

- `models.ts` — Model definitions for both tools (OpenCode uses full names, Claude Code uses aliases)
- `agents.ts` — Agent configs (only build primary agent)
- `skills.ts` — Skill configs (all behaviors: workflow, coding standards, auditors, former commands)

### Generated Files (`output/`)

**DO NOT EDIT DIRECTLY!** These are generated by `src/generate.ts`.

Output is generated for **both tools**:
- `output/opencode/` — OpenCode format (full model names, `mode: primary`, colors)
- `output/claude/` — Claude Code format (model aliases like `opus`/`haiku`)

To modify output:
1. Edit content in `content/`
2. Edit config in `config/`
3. Run `make install`

### Markdown Content Structure

- Use heading hierarchy (`#`, `##`, `###`)
- Tables for structured data
- Code blocks with language hints
- Line references: `[file:line]` or `[path:line-line]`

**Status Markers**:
| Marker | Meaning |
|--------|---------|
| `[ ]` | Pending |
| `[x]` | Done |
| `[~]` | Blocked |
| `[!]` | Needs decision |

---

## Architecture

### Skills-First Approach

Everything is a skill. Only the `build` agent exists as a primary agent. All other behaviors (planning, workshop, auditing, coding standards, etc.) are loaded on-demand via the `skill` tool.

```
content/instructions/<name>.md  →  output/opencode/skills/<name>/SKILL.md
                                →  output/claude/skills/<name>/SKILL.md
```

The build agent instruction also generates as the only agent:
```
content/instructions/execution.md  →  output/opencode/agents/build.md
                                   →  output/claude/agents/build.md
```

### Audit Flow

```
EXECUTE → Audit Orchestrator (skill) → Auditor Sub-Agents (load auditor skills) → Done
```

- `audit-orchestrator` skill spawns sub-agents that load specialized auditor skills
- Auditors review and report; orchestrator fixes issues
- Main agent **cannot self-approve**—audit approval required

---

## Adding New Content

### New Skill

1. Create `content/instructions/<skill-name>.md` (body only)
2. Add entry to `config/skills.ts`
3. Run `make install`

### New Agent (rare — prefer skills)

1. Create `content/instructions/<agent-name>.md` (body only)
2. Add entry to `config/agents.ts` with type (primary/sub)
3. Run `make install`

---

## Critical Rules

- **UPDATE DOCS** — When changing CLI args, configs, or user-facing behavior, always update `README.md` and `shell/zsh-custom.zsh` if affected
- **NEVER EDIT OR SELECT A MODEL**, this is always up to the user
- **READ CLAUDE DOCS** — When working with Claude Code features (plugins, commands, skills, agents, config), always fetch and read https://docs.anthropic.com/en/docs/claude-code first to ensure correct format and API usage
- **READ OPENCODE DOCS** — When working with OpenCode features (agents, config, models, temperature), refer to `opencode-docs-ref.md` or fetch https://opencode.ai/docs for current documentation

---

## File Types Summary

| Extension | Purpose | Location |
|-----------|---------|----------|
| `.md` | Content, generated output | `content/`, `output/` |
| `.ts` | Scripts, utilities, config | `src/`, `config/` |
| `.json` | Local config (not installed) | `opencode.json` |
