# AGENTS.md

This file provides guidance to AI coding agents working in this repository.

## Project Overview

This repository contains opinionated AI guidelines, skills, workflows, and agents for Claude Code, OpenCode, and Windsurf. The content is installed to user machines via `init.sh`. This is a **documentation/configuration repository**â€”no compiled code, but with a generator script.

## Repository Structure

```
â”œâ”€â”€ templates/               # SOURCE OF TRUTH (body content only)
â”‚   â”œâ”€â”€ skills/              # Skill templates (no frontmatter)
â”‚   â”‚   â””â”€â”€ <skill>.md
â”‚   â””â”€â”€ agents/              # Agent templates (no frontmatter)
â”‚       â””â”€â”€ <agent>.md
â”œâ”€â”€ integrations/            # GENERATED OUTPUT (do not edit directly)
â”‚   â”œâ”€â”€ claude-code/
â”‚   â”‚   â”œâ”€â”€ skills/          # Skills with Claude Code frontmatter
â”‚   â”‚   â”œâ”€â”€ sub-agents/      # Sub-agents with frontmatter
â”‚   â”‚   â””â”€â”€ mcp.json         # MCP config (mcpServers format)
â”‚   â”œâ”€â”€ opencode/
â”‚   â”‚   â”œâ”€â”€ skills/          # Skills (same as Claude Code)
â”‚   â”‚   â”œâ”€â”€ agents/          # Agents with OpenCode frontmatter
â”‚   â”‚   â””â”€â”€ mcp.json         # MCP config (OpenCode format)
â”‚   â””â”€â”€ windsurf/
â”‚       â””â”€â”€ workflows/       # Workflows with frontmatter
â”œâ”€â”€ guidelines/              # Core instruction files
â”œâ”€â”€ statusline/              # Claude Code status line
â”œâ”€â”€ generate.ts              # Generator script (contains all config + generation logic)
â”œâ”€â”€ init.sh                  # Installer script
â”œâ”€â”€ mcp.json                 # MCP servers template (source)
â””â”€â”€ AGENTS.md                # AI agent instructions for this repo
```

## Commands

### Generate Integration Files

**ALWAYS run this after modifying templates or generate.ts:**

```bash
bun generate.ts --clean
```

This generates all files in `integrations/` from `templates/` + config in `generate.ts`.

### Installer Script

```bash
# Test installation
./init.sh --help

# Test skills installation
./init.sh --skills-path /tmp/test-skills

# Test full Claude Code installation
./init.sh --rules-path /tmp/test-claude.md \
          --skills-path /tmp/test-skills \
          --agents-path /tmp/test-agents \
          --mcp-path /tmp/test-mcp.json

# Test full OpenCode installation
./init.sh --rules-path /tmp/test-agents.md \
          --skills-path /tmp/test-skills \
          --agents-path /tmp/test-opencode-agents \
          --mcp-path /tmp/test-opencode.json
```

### Shell Script Validation

```bash
# Check bash syntax
bash -n init.sh
bash -n generate.sh
bash -n statusline/statusline-command.sh

# Check with shellcheck (if available)
shellcheck init.sh generate.sh hooks/*.sh statusline/*.sh
```

---

## Code Style Guidelines

### Template Files (`templates/`)

**No frontmatter!** Templates contain only the body content. Frontmatter is added during generation.

### Generator Configuration (`generate.ts`)

All configuration is centralized in `generate.ts`:

- `MODELS` - Model mappings for smart/fast per platform
- `AGENT_CONFIGS` - Agent definitions with platform-specific settings
- `SKILL_DESCRIPTIONS` - Skill trigger descriptions
- `WORKFLOW_NAME_MAP` - Skill-to-workflow name mappings

### Generated Files (`integrations/`)

**DO NOT EDIT DIRECTLY!** These are generated by `generate.ts`.

To modify output:
1. Edit templates in `templates/`
2. Edit config in `generate.ts`
3. Run `bun generate.ts --clean`

### Markdown Content Structure

- Use heading hierarchy (`#`, `##`, `###`)
- Tables for structured data (criteria, decisions, verdicts)
- Code blocks with language hints for commands
- Line references: `[file:line]` or `[path:line-line]`

**Status/Verdict Markers**:
| Marker | Meaning |
|--------|---------|
| `[ ]` | Pending |
| `[x]` | Done |
| `[~]` | Blocked |
| `[!]` | Needs decision |
| `âœ…` | Approved/Pass |
| `âš ï¸` | Warning |
| `ğŸ”„` | Request changes |
| `âŒ` | Rejected/Fail |
| `ğŸ”´` | Blocker |
| `ğŸŸ¡` | Should fix |
| `ğŸŸ¢` | Minor/Nitpick |

### Shell Scripts

**Style Requirements**:
```bash
#!/bin/bash
set -euo pipefail
```

- Use color constants for output (`RED`, `GREEN`, `YELLOW`, `BLUE`, `NC`)
- Define cleanup functions with traps: `trap cleanup EXIT ERR INT TERM`
- Use functions for modularity
- Lowercase with hyphens for filenames: `log-changes.sh`, `statusline-command.sh`

---

## Key Architecture

### Single Source of Truth

```
templates/skills/planning.md     â†’ integrations/claude-code/skills/planning/SKILL.md
                                 â†’ integrations/opencode/skills/planning/SKILL.md
                                 â†’ integrations/windsurf/workflows/plan-mode.md

templates/agents/auditor.md      â†’ integrations/claude-code/sub-agents/auditor.md
                                 â†’ integrations/opencode/agents/auditor.md
```

### Platform Differences

| Platform | Skills Format | Agents Format |
|----------|---------------|---------------|
| Claude Code | `skills/<name>/SKILL.md` with frontmatter | `sub-agents/<name>.md` |
| OpenCode | Same as Claude Code | `agents/<name>.md` with different frontmatter |
| Windsurf | `workflows/<name>-mode.md` (no frontmatter) | N/A |

### Full Feature Flow

```
WORKSHOP â†’ PLAN â†’ EXECUTE (+ Audit) â†’ REFLECTION
```

- Each phase handled by dedicated skill
- State file: `docs/ai/<feature>/state.md`
- Auditor sub-agent runs **once after execute phase**
- Main agent **cannot self-approve**â€”audit approval required

---

## Adding New Content

### New Skill

1. Create `templates/skills/<skill-name>.md` (body only, no frontmatter)
2. Add entry to `SKILL_DESCRIPTIONS` in `generate.ts`
3. Optionally add to `WORKFLOW_NAME_MAP` if workflow name differs from `<name>-mode`
4. Run `bun generate.ts --clean`

### New Agent

1. Create `templates/agents/<agent-name>.md` (body only, no frontmatter)
2. Add entry to `AGENT_CONFIGS` in `generate.ts` with:
   - `template`: path relative to templates/
   - `description`: agent description
   - `modelType`: "smart" or "fast"
   - `claudeCode`: (optional) Claude Code specific config
   - `opencode`: (optional) OpenCode specific config
3. Run `bun generate.ts --clean`

### New Hook

1. Add script to `hooks/`
2. Update `init.sh` to install it
3. Document in README

---

## Critical Rules (Inherited)

These apply when this repo's guidelines are installed in target projects:

- **NO SHORTCUTS** â€” Stop and notify if only unsafe workarounds work
- **STAY IN SCOPE** â€” Halt if blocker is outside task scope
- **PROTECT DATA** â€” Never modify development DB destructively
- **NO SELF-APPROVAL** â€” Use auditor sub-agent for code approval
- **NO DEAD CODE** â€” No commented blocks, debug prints, leftover TODOs
- **PREFER EXTENDING** â€” Extend existing files over creating new ones
- **AFTER-TASK CHECKLIST** â€” Run type-check/lint/format/tests

---

## File Types Summary

| Extension | Purpose | Location |
|-----------|---------|----------|
| `.md` | Templates, generated content | `templates/`, `integrations/` |
| `.ts` | Generator script with config | `generate.ts` |
| `.sh` | Scripts | `*.sh`, `hooks/`, `statusline/` |
| `.json` | MCP config | `mcp.json` |
